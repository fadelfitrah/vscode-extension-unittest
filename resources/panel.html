<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Multi-Language Unit Test Generator</title>
    <style>
      :root {
        --bg-color: #1e1e1e;
        --card-bg: #252526;
        --accent: #007acc;
        --accent-hover: #005a9e;
        --text-color: #cccccc;
        --text-muted: #969696;
        --border-color: #3c3c3c;
        --success: #4ec9b0;
        --warning: #ffcc02;
        --error: #f48771;
        --header-bg: #2d2d30;
        --python-color: #3572a5;
        --javascript-color: #f1e05a;
        --typescript-color: #3178c6;
        --java-color: #b07219;
        --csharp-color: #178600;
        --go-color: #00add8;
        --rust-color: #dea584;
        --php-color: #4f5d95;
        --ruby-color: #701516;
        --kotlin-color: #f18e33;
        --swift-color: #f05138;
        --cpp-color: #f34b7d;
      }

      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background: var(--bg-color);
        color: var(--text-color);
        line-height: 1.4;
        height: 100vh;
        display: flex;
        flex-direction: column;
        overflow: hidden;
      }

      .container {
        flex: 1;
        display: flex;
        flex-direction: column;
        padding: 0;
        position: relative;
      }

      .header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        background: var(--header-bg);
        padding: 12px 16px;
        border-bottom: 1px solid var(--border-color);
      }

      .header-left {
        display: flex;
        align-items: center;
      }

      .header img {
        width: 30px;
        height: 30px;
        margin-right: 8px;
      }

      .header h2 {
        color: #018020;
        font-size: 1.1rem;
        font-weight: 600;
      }

      .header-right {
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .language-badge {
        padding: 2px 8px;
        border-radius: 12px;
        font-size: 0.75rem;
        font-weight: 500;
        background: var(--accent);
        color: white;
      }

      .language-badge.python {
        background: var(--python-color);
      }
      .language-badge.javascript {
        background: var(--javascript-color);
        color: #333;
      }
      .language-badge.typescript {
        background: var(--typescript-color);
      }
      .language-badge.java {
        background: var(--java-color);
      }
      .language-badge.csharp {
        background: var(--csharp-color);
      }
      .language-badge.go {
        background: var(--go-color);
      }
      .language-badge.rust {
        background: var(--rust-color);
        color: #333;
      }
      .language-badge.php {
        background: var(--php-color);
      }
      .language-badge.ruby {
        background: var(--ruby-color);
      }
      .language-badge.kotlin {
        background: var(--kotlin-color);
        color: #333;
      }
      .language-badge.swift {
        background: var(--swift-color);
      }
      .language-badge.cpp {
        background: var(--cpp-color);
      }

      .result-section {
        flex: 1;
        display: flex;
        flex-direction: column;
        padding: 16px;
        border-bottom: 1px solid var(--border-color);
        overflow: hidden;
      }

      .result-section h3 {
        margin-bottom: 8px;
        font-size: 0.9rem;
        color: var(--text-color);
        font-weight: 500;
      }

      .result {
        background: var(--bg-color);
        border: 1px solid var(--border-color);
        border-radius: 4px;
        padding: 12px;
        flex: 1;
        overflow-y: auto;
        font-family: "Cascadia Code", "Consolas", monospace;
        font-size: 12px;
        line-height: 1.3;
        white-space: pre-wrap;
        word-wrap: break-word;
      }

      .fixed-controls {
        padding: 10px;
        background: var(--card-bg);
        border-bottom: 1px solid var(--border-color);
      }

      .slide-panel {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        background: var(--card-bg);
        border-top: 1px solid var(--border-color);
        transform: translateY(calc(100% - 40px));
        transition: transform 0.3s ease;
        z-index: 100;
        max-height: 70vh;
        overflow-y: auto;
      }

      .slide-panel.open {
        transform: translateY(0);
      }

      .slide-panel-handle {
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 8px;
        background: var(--header-bg);
        cursor: pointer;
        border-bottom: 1px solid var(--border-color);
      }

      .slide-panel-handle:hover {
        background: var(--accent-hover);
      }

      .slide-panel-content {
        padding: 10px;
      }

      .form-group {
        margin-bottom: 12px;
      }

      .form-group label {
        display: block;
        margin-bottom: 4px;
        font-weight: 500;
        color: var(--text-color);
        font-size: 0.85rem;
      }

      select,
      input[type="number"],
      input[type="text"] {
        width: 100%;
        background: var(--bg-color);
        border: 1px solid var(--border-color);
        color: var(--text-color);
        padding: 6px 8px;
        border-radius: 4px;
        font-size: 0.85rem;
      }

      select:focus,
      input:focus {
        outline: none;
        border-color: var(--accent);
      }

      .checkbox-group {
        display: flex;
        align-items: center;
        gap: 6px;
        margin: 8px 0;
      }

      .checkbox-group input[type="checkbox"] {
        width: auto;
      }

      .checkbox-group label {
        margin: 0;
        font-size: 0.85rem;
      }

      .grid-2 {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 8px;
      }

      .grid-3 {
        display: grid;
        grid-template-columns: 1fr 1fr 1fr;
        gap: 6px;
      }

      .grid-4 {
        display: grid;
        grid-template-columns: 1fr 1fr 1fr 1fr;
        gap: 6px;
      }

      .btn {
        background: var(--accent);
        color: white;
        border: none;
        padding: 8px 12px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 0.85rem;
        font-weight: 500;
        transition: background 0.2s;
        width: 100%;
      }

      .btn:hover {
        background: var(--accent-hover);
      }

      .btn-secondary {
        background: var(--border-color);
      }

      .btn-secondary:hover {
        background: #4a4a4a;
      }

      .btn-success {
        background: var(--success);
      }

      .btn-success:hover {
        background: #3aa890;
      }

      .btn-warning {
        background: var(--warning);
        color: #000;
      }

      .btn-warning:hover {
        background: #e6b800;
      }

      .buttons {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 8px;
        margin: 12px 0;
      }

      .buttons-single {
        display: grid;
        grid-template-columns: 1fr;
        gap: 8px;
        margin: 12px 0;
      }

      .coverage-section {
        margin-top: 12px;
        padding-top: 12px;
        border-top: 1px solid var(--border-color);
      }

      .coverage-section h3 {
        margin-bottom: 6px;
        font-size: 0.9rem;
        color: var(--text-color);
        font-weight: 500;
      }

      .coverage-result {
        background: var(--bg-color);
        border: 1px solid var(--border-color);
        border-radius: 4px;
        padding: 8px;
        min-height: 60px;
        max-height: 120px;
        overflow-y: auto;
        font-family: "Cascadia Code", "Consolas", monospace;
        font-size: 11px;
        line-height: 1.3;
        white-space: pre-wrap;
      }

      .footer {
        text-align: center;
        padding: 8px 16px;
        color: var(--text-muted);
        font-size: 0.7rem;
        border-top: 1px solid var(--border-color);
        background: var(--header-bg);
      }

      .hidden {
        display: none;
      }

      .status {
        padding: 6px 8px;
        border-radius: 4px;
        font-size: 0.8rem;
        margin-bottom: 8px;
      }

      .status.info {
        background: rgba(0, 122, 204, 0.1);
        border: 1px solid var(--accent);
      }

      .status.success {
        background: rgba(78, 201, 176, 0.1);
        border: 1px solid var(--success);
      }

      .status.warning {
        background: rgba(255, 204, 2, 0.1);
        border: 1px solid var(--warning);
      }

      .status.error {
        background: rgba(244, 135, 113, 0.1);
        border: 1px solid var(--error);
      }

      .quality-indicators {
        display: flex;
        gap: 12px;
        margin-bottom: 8px;
        font-size: 0.8rem;
        flex-wrap: wrap;
      }

      .quality-score,
      .coverage-preview,
      .test-stats,
      .complexity-score {
        display: flex;
        align-items: center;
        gap: 4px;
        padding: 4px 8px;
        border-radius: 4px;
        background: var(--card-bg);
        border: 1px solid var(--border-color);
      }

      .score-label,
      .coverage-label,
      .stats-label,
      .complexity-label {
        color: var(--text-muted);
      }

      .score-value,
      .coverage-value,
      .stats-value,
      .complexity-value {
        color: var(--text-color);
        font-weight: 500;
      }

      .score-value.excellent {
        color: var(--success);
      }
      .score-value.good {
        color: var(--accent);
      }
      .score-value.fair {
        color: var(--warning);
      }
      .score-value.poor {
        color: var(--error);
      }

      .quality-details {
        display: none;
        background: var(--card-bg);
        border: 1px solid var(--border-color);
        border-radius: 4px;
        padding: 8px;
        margin-bottom: 8px;
        font-size: 0.8rem;
      }

      .quality-details.visible {
        display: block;
      }

      .quality-features {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 6px;
        margin-top: 6px;
      }

      .quality-feature {
        display: flex;
        align-items: center;
        gap: 4px;
      }

      .feature-indicator {
        width: 8px;
        height: 8px;
        border-radius: 50%;
      }

      .feature-indicator.present {
        background: var(--success);
      }

      .feature-indicator.missing {
        background: var(--error);
      }

      .feature-label {
        font-size: 0.75rem;
        color: var(--text-muted);
      }

      .advanced-toggle {
        background: none;
        border: none;
        color: var(--accent);
        font-size: 0.75rem;
        cursor: pointer;
        padding: 4px 0;
        text-align: left;
        display: flex;
        align-items: center;
        gap: 4px;
      }

      .advanced-toggle:hover {
        text-decoration: underline;
      }

      .advanced-options {
        display: none;
        background: var(--bg-color);
        border: 1px solid var(--border-color);
        border-radius: 4px;
        padding: 8px;
        margin-top: 8px;
        margin-bottom: 12px;
      }

      .advanced-options.visible {
        display: block;
      }

      .file-item {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 4px 0;
      }

      .file-language-badge {
        padding: 1px 6px;
        border-radius: 10px;
        font-size: 0.7rem;
        font-weight: 500;
        min-width: 60px;
        text-align: center;
      }

      .file-name {
        flex: 1;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
      }

      .language-selector {
        display: flex;
        gap: 8px;
        margin-bottom: 12px;
      }

      .lang-btn {
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 0.75rem;
        cursor: pointer;
        border: 1px solid var(--border-color);
        background: var(--card-bg);
        color: var(--text-color);
        flex: 1;
        text-align: center;
      }

      .lang-btn.active {
        border-color: var(--accent);
        background: var(--accent);
        color: white;
      }

      .lang-btn:hover:not(.active) {
        background: var(--border-color);
      }

      /* Scrollbar styling */
      ::-webkit-scrollbar {
        width: 8px;
      }

      ::-webkit-scrollbar-track {
        background: var(--bg-color);
      }

      ::-webkit-scrollbar-thumb {
        background: var(--border-color);
        border-radius: 4px;
      }

      ::-webkit-scrollbar-thumb:hover {
        background: #555;
      }

      .language-select-container {
        position: relative;
      }

      .language-select-container select {
        padding-right: 24px;
        appearance: none;
        -webkit-appearance: none;
        -moz-appearance: none;
      }

      .language-select-container::after {
        content: "‚ñº";
        position: absolute;
        right: 10px;
        top: 50%;
        transform: translateY(-50%);
        pointer-events: none;
        color: var(--text-muted);
        font-size: 0.7rem;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <!-- Header -->
      <div class="header">
        <div class="header-left">
          <img src="{ICON_URI}" alt="Icon" />
          <h2>Multi-Language Test Generator</h2>
        </div>
        <div class="header-right">
          <div id="currentLanguageBadge" class="language-badge">PYTHON</div>
        </div>
      </div>

      <!-- Main Result Area (Top) -->
      <div class="result-section">
        <div class="quality-indicators">
          <div class="quality-score">
            <span class="score-label">Quality:</span>
            <span class="score-value" id="qualityScore">--</span>
          </div>
          <div class="coverage-preview">
            <span class="coverage-label">Coverage:</span>
            <span class="coverage-value" id="estimatedCoverage">--%</span>
          </div>
          <div class="test-stats">
            <span class="stats-label">Tests:</span>
            <span class="stats-value" id="testStats">--</span>
          </div>
          <div class="complexity-score">
            <span class="complexity-label">Complexity:</span>
            <span class="complexity-value" id="complexityScore">--</span>
          </div>
        </div>

        <div id="qualityDetails" class="quality-details">
          <div class="quality-features">
            <div class="quality-feature">
              <div class="feature-indicator" id="edgeCasesIndicator"></div>
              <span class="feature-label">Edge Cases</span>
            </div>
            <div class="quality-feature">
              <div class="feature-indicator" id="errorCasesIndicator"></div>
              <span class="feature-label">Error Cases</span>
            </div>
            <div class="quality-feature">
              <div class="feature-indicator" id="mockingIndicator"></div>
              <span class="feature-label">Mocking</span>
            </div>
            <div class="quality-feature">
              <span class="feature-label">Assertions:</span>
              <span class="stats-value" id="assertionCount">--</span>
            </div>
          </div>
        </div>

        <h3>Generated Test Code</h3>
        <div id="result" class="result">
          // Select a source file and click Generate to create unit tests
        </div>
      </div>

      <!-- Fixed Controls Section -->
      <div class="fixed-controls">
        <div class="grid-2">
          <div class="form-group">
            <label for="fileSelect">Source File</label>
            <select id="fileSelect">
              <option value="">Loading files...</option>
            </select>
          </div>

          <div class="form-group language-select-container">
            <label for="language">Programming Language</label>
            <select id="language">
              <option value="python">Python</option>
              <option value="javascript">JavaScript</option>
              <option value="typescript">TypeScript</option>
              <option value="java">Java</option>
              <option value="csharp">C#</option>
              <option value="go">Go</option>
              <option value="rust">Rust</option>
              <option value="php">PHP</option>
              <option value="ruby">Ruby</option>
              <option value="kotlin">Kotlin</option>
              <option value="swift">Swift</option>
              <option value="cpp">C++</option>
            </select>
          </div>
        </div>

        <div class="grid-2">
          <div class="form-group">
            <label for="testFramework">Test Framework</label>
            <select id="testFramework">
              <option value="unittest">unittest</option>
              <option value="pytest">pytest</option>
            </select>
          </div>

          <div class="form-group">
            <label for="provider">AI Provider</label>
            <select id="provider">
              <option value="openai">GPT-OSS-20B</option>
              <option value="metalamma">Meta Llama</option>
              <option value="groq">Groq</option>
              <option value="phi3">Microsoft/Phi-3</option>
              <option value="codexmini">CodeX-Mini</option>
              <option value="deepseek">DeepSeek</option>
            </select>
          </div>
        </div>

        <div class="buttons">
          <button id="generateBtn" class="btn">Generate Tests</button>
          <button id="togglePanelBtn" class="btn btn-secondary">
            ‚öôÔ∏è Advanced Options
          </button>
        </div>
      </div>

      <!-- Slide-up Panel -->
      <div class="slide-panel" id="slidePanel">
        <div class="slide-panel-handle" id="panelHandle">
          <span>‚ñº Advanced Configuration</span>
        </div>
        <div class="slide-panel-content">
          <div class="advanced-options visible">
            <div class="grid-3">
              <div class="checkbox-group">
                <input id="edgeCases" type="checkbox" checked />
                <label for="edgeCases">Edge Cases</label>
              </div>
              <div class="checkbox-group">
                <input id="errorCases" type="checkbox" checked />
                <label for="errorCases">Error Cases</label>
              </div>
              <div class="checkbox-group">
                <input id="mocking" type="checkbox" checked />
                <label for="mocking">Mocking</label>
              </div>
            </div>

            <div class="grid-2">
              <div class="form-group">
                <label for="testCases">Test Cases</label>
                <input
                  id="testCases"
                  type="number"
                  value="3"
                  min="1"
                  max="10"
                />
              </div>
              <div class="form-group">
                <label for="coverage">Coverage Target</label>
                <input
                  id="coverage"
                  type="number"
                  value="80"
                  min="50"
                  max="100"
                />
              </div>
            </div>

            <div class="grid-2">
              <div class="form-group">
                <label for="testStyle">Test Style</label>
                <select id="testStyle">
                  <option value="given_when_then">Given-When-Then</option>
                  <option value="arrange_act_assert">Arrange-Act-Assert</option>
                </select>
              </div>

              <div class="form-group">
                <label for="mockingFramework">Mocking Framework</label>
                <select id="mockingFramework">
                  <option value="unittest.mock">unittest.mock</option>
                  <option value="pytest-mock">pytest-mock</option>
                  <option value="freezegun">freezegun</option>
                </select>
              </div>
            </div>

            <div class="buttons-single">
              <button id="saveFile" class="btn btn-success hidden">
                üíæ Save Test File
              </button>
            </div>
          </div>

          <div class="buttons">
            <button id="coverageBtn" class="btn btn-secondary">
              üìä Run Coverage
            </button>
            <button id="analyzeBtn" class="btn btn-warning">
              üîç Analyze Quality
            </button>
          </div>

          <div class="coverage-section">
            <h3>Coverage Report</h3>
            <div id="coverageResult" class="coverage-result">
              No coverage data available
            </div>
          </div>
        </div>
      </div>

      <div class="footer">Multi-Language Unit Test Generator ¬© 2025</div>
    </div>

    <script>
      const vscode = acquireVsCodeApi();
      let lastGeneratedResult = "";
      let lastGeneratedMeta = null;
      let isPanelOpen = false;
      let currentLanguage = "python";
      let currentFileList = [];
      let languageFrameworks = {};
      const LANGUAGE_FRAMEWORKS = { LANGUAGE_FRAMEWORKS };

      // Initialize when DOM is loaded
      window.addEventListener("DOMContentLoaded", () => {
        // Initialize language frameworks from injected data
        languageFrameworks = LANGUAGE_FRAMEWORKS || {};

        // Notify host that the webview is ready
        vscode.postMessage({ command: "ready" });

        // Request file list after a brief delay
        setTimeout(() => {
          try {
            vscode.postMessage({ command: "requestFileList" });
          } catch (e) {
            console.error("Failed to post requestFileList message:", e);
          }
        }, 120);

        // Load saved state
        const state = vscode.getState();
        if (state) {
          if (state.panelOpen !== undefined) {
            isPanelOpen = state.panelOpen;
            toggleSlidePanel(isPanelOpen);
          }
          if (state.language) {
            document.getElementById("language").value = state.language;
            currentLanguage = state.language;
            updateLanguageBadge();
            updateFrameworkOptions();
          }
        }

        // Initialize UI
        updateLanguageBadge();
        updateFrameworkOptions();
      });

      // Handle messages from extension
      window.addEventListener("message", (event) => {
        const message = event.data;

        switch (message.command) {
          case "fileList":
            updateFileList(message.files);
            break;
          case "showResult":
            showResult(message.result, message.metadata);
            break;
          case "coverageResult":
            showCoverageResult(message);
            break;
          case "status":
            showStatus(message.message, message.type);
            break;
          case "qualityAnalysis":
            showQualityAnalysis(message.metrics);
            break;
          case "configUpdate":
            updateConfiguration(message.config);
            break;
          case "languageFrameworks":
            updateLanguageFrameworkOptions(
              message.language,
              message.frameworks
            );
            break;
          case "loadCode":
            updateCurrentFileInfo(message);
            break;
        }
      });

      function updateFileList(files) {
        console.log("updateFileList called with:", files);
        const select = document.getElementById("fileSelect");
        select.innerHTML = "";
        currentFileList = files || [];

        if (!files || files.length === 0) {
          const option = document.createElement("option");
          option.value = "";
          option.textContent = "No source files found in workspace";
          select.appendChild(option);
          return;
        }

        // Normalize file items
        const normalized = files
          .map((item) => {
            if (typeof item === "string") {
              return { path: item, language: detectLanguageFromPath(item) };
            }
            return {
              path: item.path || item.uri || item.fsPath || item.file || "",
              language:
                item.language || detectLanguageFromPath(item.path || ""),
            };
          })
          .filter((item) => item.path);

        // Create optgroup for each language
        const languageGroups = {};
        normalized.forEach((item) => {
          if (!languageGroups[item.language]) {
            languageGroups[item.language] = [];
          }
          languageGroups[item.language].push(item);
        });

        // Sort languages alphabetically
        const sortedLanguages = Object.keys(languageGroups).sort();

        // Create optgroups
        sortedLanguages.forEach((lang) => {
          const optgroup = document.createElement("optgroup");
          optgroup.label = lang.charAt(0).toUpperCase() + lang.slice(1);

          languageGroups[lang].forEach((item) => {
            const option = document.createElement("option");
            option.value = item.path;
            option.textContent = getFileNameFromPath(item.path);
            option.title = item.path;
            option.dataset.language = lang;

            // Style option based on language
            option.style.color = getLanguageColor(lang);
            optgroup.appendChild(option);
          });

          select.appendChild(optgroup);
        });
      }

      function detectLanguageFromPath(path) {
        const ext = path.split(".").pop().toLowerCase();
        const extensionMap = {
          py: "python",
          js: "javascript",
          jsx: "javascript",
          ts: "typescript",
          tsx: "typescript",
          java: "java",
          cs: "csharp",
          go: "go",
          rs: "rust",
          php: "php",
          rb: "ruby",
          kt: "kotlin",
          kts: "kotlin",
          swift: "swift",
          cpp: "cpp",
          cc: "cpp",
          cxx: "cpp",
          h: "cpp",
          hpp: "cpp",
          hxx: "cpp",
        };
        return extensionMap[ext] || "python";
      }

      function getFileNameFromPath(path) {
        const parts = path.replace(/\\\\/g, "/").split("/");
        return parts.slice(-1)[0] || path;
      }

      function getLanguageColor(language) {
        const colorMap = {
          python: "#3572A5",
          javascript: "#f1e05a",
          typescript: "#3178c6",
          java: "#b07219",
          csharp: "#178600",
          go: "#00ADD8",
          rust: "#dea584",
          php: "#4F5D95",
          ruby: "#701516",
          kotlin: "#F18E33",
          swift: "#F05138",
          cpp: "#f34b7d",
        };
        return colorMap[language] || "#cccccc";
      }

      function showResult(result, metadata) {
        const resultElement = document.getElementById("result");
        const saveButton = document.getElementById("saveFile");

        resultElement.textContent = result;
        lastGeneratedResult = result;
        lastGeneratedMeta = metadata || null;
        saveButton.classList.remove("hidden");

        // Update current language from metadata
        if (metadata && metadata.language) {
          currentLanguage = metadata.language;
          document.getElementById("language").value = currentLanguage;
          updateLanguageBadge();
        }

        // Update quality indicators
        if (metadata && metadata.qualityMetrics) {
          updateQualityIndicators(metadata.qualityMetrics);
        } else {
          const basicMetrics = analyzeTestQualityBasic(result, currentLanguage);
          updateQualityIndicators(basicMetrics);
        }

        // Clear coverage result when new test is generated
        document.getElementById("coverageResult").textContent =
          "No coverage data available";
      }

      function updateQualityIndicators(metrics) {
        document.getElementById("qualityScore").textContent =
          metrics.qualityScore;
        document.getElementById(
          "qualityScore"
        ).className = `score-value ${metrics.qualityScore.toLowerCase()}`;

        document.getElementById(
          "estimatedCoverage"
        ).textContent = `${metrics.estimatedCoverage}%`;
        document.getElementById("testStats").textContent = metrics.testCount;
        document.getElementById("complexityScore").textContent =
          metrics.complexity;
        document.getElementById("assertionCount").textContent =
          metrics.assertionCount;

        // Update feature indicators
        document.getElementById(
          "edgeCasesIndicator"
        ).className = `feature-indicator ${
          metrics.hasEdgeCases ? "present" : "missing"
        }`;
        document.getElementById(
          "errorCasesIndicator"
        ).className = `feature-indicator ${
          metrics.hasErrorCases ? "present" : "missing"
        }`;
        document.getElementById(
          "mockingIndicator"
        ).className = `feature-indicator ${
          metrics.hasMocking ? "present" : "missing"
        }`;

        // Show quality details if not excellent
        const qualityDetails = document.getElementById("qualityDetails");
        if (metrics.qualityScore !== "Excellent") {
          qualityDetails.classList.add("visible");
        } else {
          qualityDetails.classList.remove("visible");
        }
      }

      function analyzeTestQualityBasic(testCode, language = "python") {
        // Language-specific patterns
        const patterns = {
          python: {
            testFunction: /\bdef\s+test_/g,
            assertion: /\bassert\s|\bself\.assert|\bunittest\.assert/g,
            mocking: /\bmock|patch|MagicMock|Mock\b/,
          },
          javascript: {
            testFunction: /\b(it|test)\(/g,
            assertion: /\bexpect\(|\bassert\(|\bshould\.equal/g,
            mocking: /\bjest\.mock|\bsinon|\bMock\b/,
          },
          typescript: {
            testFunction: /\b(it|test)\(/g,
            assertion: /\bexpect\(|\bassert\(|\bshould\.equal/g,
            mocking: /\bjest\.mock|\bsinon|\bMock\b/,
          },
          java: {
            testFunction: /\b@Test\b|\bpublic void test/g,
            assertion: /\bassertThat\(|\bassertEquals\(|\bassertTrue\(/g,
            mocking: /\b@Mock|\bMockito/,
          },
          csharp: {
            testFunction: /\b\[Test\]|\bpublic void Test/g,
            assertion: /\bAssert\.Equal\(|\bAssert\.True\(|\bAssert\.False\(/g,
            mocking: /\bMock<|\bIt\.IsAny/,
          },
          go: {
            testFunction: /\bfunc Test\w+\(/g,
            assertion: /\bt\.Error\(|\bt\.Fatal\(|\bt\.Fatalf\(/g,
            mocking: /\bNewMock|\bgomock/,
          },
        };

        const langPatterns = patterns[language] || patterns.python;
        const lower = testCode.toLowerCase();

        const testCount = (testCode.match(langPatterns.testFunction) || [])
          .length;
        const assertionCount = (testCode.match(langPatterns.assertion) || [])
          .length;
        const hasEdgeCases =
          /\bedge|\bboundary|\bmin\b|\bmax\b|\bzero|\bempty|\bnull\b/.test(
            lower
          );
        const hasErrorCases =
          /\berror|\bexception|\btry\b|\bcatch\b|\bthrow\b/.test(lower);
        const hasMocking = testCode.match(langPatterns.mocking) !== null;

        // Complexity estimation
        const controlStructures = (
          testCode.match(
            /\bif\b|\belse\b|\bfor\b|\bwhile\b|\btry\b|\bcatch\b|\bswitch\b/g
          ) || []
        ).length;
        const cognitivePenalty = Math.floor(testCode.split("\n").length / 40);
        const complexity = Math.max(1, controlStructures + cognitivePenalty);

        // Quality classification
        let qualityScore = "Poor";
        if (testCount >= 2 && assertionCount >= testCount) {
          qualityScore = "Fair";
        }
        if (
          testCount >= 3 &&
          assertionCount >= testCount * 1.2 &&
          (hasEdgeCases || hasErrorCases)
        ) {
          qualityScore = "Good";
        }
        if (
          testCount >= 5 &&
          assertionCount >= testCount * 1.5 &&
          hasEdgeCases &&
          hasErrorCases &&
          hasMocking
        ) {
          qualityScore = "Excellent";
        }

        // Estimated coverage
        const estimatedCoverage = Math.min(
          100,
          testCount * 15 +
            assertionCount * 3 +
            (hasEdgeCases ? 10 : 0) +
            (hasErrorCases ? 10 : 0)
        );

        return {
          qualityScore,
          estimatedCoverage,
          testCount,
          assertionCount,
          hasEdgeCases,
          hasErrorCases,
          hasMocking,
          complexity,
        };
      }

      function showQualityAnalysis(metrics) {
        updateQualityIndicators(metrics);
        showStatus("Quality analysis completed", "success");
      }

      function showCoverageResult(message) {
        const covEl = document.getElementById("coverageResult");

        if (!message.success) {
          covEl.textContent =
            "Coverage failed: " + (message.message || "Unknown error");
          return;
        }

        const data = message.data;
        let output = "";

        if (data && data.total && data.total.percent_covered !== undefined) {
          output = `Total: ${data.total.percent_covered.toFixed(1)}%\n\n`;
        } else {
          output = "Total: N/A\n\n";
        }

        if (data && data.files) {
          data.files.sort(
            (a, b) => (b.percent_covered || 0) - (a.percent_covered || 0)
          );

          data.files.forEach((file) => {
            output += `${file.file}: ${(file.percent_covered || 0).toFixed(
              1
            )}%\n`;
          });
        }

        covEl.textContent = output;
      }

      function showStatus(message, type = "info") {
        console.log(`Status [${type}]:`, message);

        const statusEl = document.createElement("div");
        statusEl.className = `status ${type}`;
        statusEl.textContent = message;

        const fixedControls = document.querySelector(".fixed-controls");
        fixedControls.insertBefore(statusEl, fixedControls.firstChild);

        // Auto-remove after 3 seconds
        setTimeout(() => {
          if (statusEl.parentNode) {
            statusEl.parentNode.removeChild(statusEl);
          }
        }, 3000);
      }

      function updateConfiguration(config) {
        if (config.defaultProvider) {
          document.getElementById("provider").value = config.defaultProvider;
        }

        if (config.defaultTestCases) {
          document.getElementById("testCases").value = config.defaultTestCases;
        }

        if (config.defaultCoverage) {
          document.getElementById("coverage").value = config.defaultCoverage;
        }

        if (config.enableMocking !== undefined) {
          document.getElementById("mocking").checked = config.enableMocking;
        }
      }

      function toggleSlidePanel(open) {
        const slidePanel = document.getElementById("slidePanel");
        const toggleBtn = document.getElementById("togglePanelBtn");

        if (open) {
          slidePanel.classList.add("open");
          toggleBtn.textContent = "‚öôÔ∏è Hide Options";
        } else {
          slidePanel.classList.remove("open");
          toggleBtn.textContent = "‚öôÔ∏è Advanced Options";
        }

        isPanelOpen = open;
        vscode.setState({ panelOpen: open });
      }

      function updateLanguageBadge() {
        const badge = document.getElementById("currentLanguageBadge");
        badge.textContent = currentLanguage.toUpperCase();
        badge.className = `language-badge ${currentLanguage}`;
      }

      function updateFrameworkOptions() {
        const frameworks = languageFrameworks[currentLanguage] || {
          testFrameworks: ["custom"],
          mockingFrameworks: ["custom"],
        };

        // Update test framework dropdown
        const testFrameworkSelect = document.getElementById("testFramework");
        testFrameworkSelect.innerHTML = "";
        frameworks.testFrameworks.forEach((framework) => {
          const option = document.createElement("option");
          option.value = framework;
          option.textContent = framework;
          testFrameworkSelect.appendChild(option);
        });

        // Update mocking framework dropdown
        const mockingFrameworkSelect =
          document.getElementById("mockingFramework");
        mockingFrameworkSelect.innerHTML = "";
        frameworks.mockingFrameworks.forEach((framework) => {
          const option = document.createElement("option");
          option.value = framework;
          option.textContent = framework;
          mockingFrameworkSelect.appendChild(option);
        });

        // Request updated frameworks from extension
        vscode.postMessage({
          command: "getLanguageFrameworks",
          language: currentLanguage,
        });
      }

      function updateLanguageFrameworkOptions(language, frameworks) {
        if (language === currentLanguage) {
          // Update UI with fresh framework data
          languageFrameworks[language] = frameworks;
          updateFrameworkOptions();
        }
      }

      function updateCurrentFileInfo(message) {
        if (message.fileName && message.language) {
          currentLanguage = message.language;
          document.getElementById("language").value = currentLanguage;
          updateLanguageBadge();
          updateFrameworkOptions();

          // Save state
          vscode.setState({ language: currentLanguage });
        }
      }

      // Event listeners
      document.getElementById("generateBtn").addEventListener("click", () => {
        const fileName = document.getElementById("fileSelect").value;
        if (!fileName) {
          showStatus("Please select a source file", "error");
          return;
        }

        const language = document.getElementById("language").value;
        currentLanguage = language;
        updateLanguageBadge();
        updateFrameworkOptions();

        vscode.postMessage({
          command: "generate",
          fileName: fileName,
          language: language,
          provider: document.getElementById("provider").value,
          framework: document.getElementById("testFramework").value,
          mocking: document.getElementById("mocking").checked,
          mockingFramework: document.getElementById("mockingFramework").value,
          coverage: document.getElementById("coverage").value,
          testCases: document.getElementById("testCases").value,
          includeEdgeCases: document.getElementById("edgeCases").checked,
          includeErrorCases: document.getElementById("errorCases").checked,
          testStyle: document.getElementById("testStyle").value,
        });

        // Save language state
        vscode.setState({ language: currentLanguage });
      });

      document.getElementById("coverageBtn").addEventListener("click", () => {
        document.getElementById("coverageResult").textContent =
          "Running coverage analysis...";
        vscode.postMessage({
          command: "generateCoverage",
          language: currentLanguage,
        });
      });

      document.getElementById("analyzeBtn").addEventListener("click", () => {
        const testCode = lastGeneratedResult;
        if (!testCode) {
          showStatus("No test code to analyze", "error");
          return;
        }

        vscode.postMessage({
          command: "analyzeQuality",
          testCode: testCode,
          sourceCode: "",
          language: currentLanguage,
        });
      });

      document.getElementById("saveFile").addEventListener("click", () => {
        const fileName = document.getElementById("fileSelect").value;
        if (!fileName || !lastGeneratedResult) {
          showStatus("No test code to save", "error");
          return;
        }

        vscode.postMessage({
          command: "saveFile",
          result: lastGeneratedResult,
          fileName: fileName,
          language: currentLanguage,
          metadata: lastGeneratedMeta,
        });
      });

      document
        .getElementById("togglePanelBtn")
        .addEventListener("click", () => {
          toggleSlidePanel(!isPanelOpen);
        });

      document.getElementById("panelHandle").addEventListener("click", () => {
        toggleSlidePanel(!isPanelOpen);
      });

      document.getElementById("language").addEventListener("change", (e) => {
        currentLanguage = e.target.value;
        updateLanguageBadge();
        updateFrameworkOptions();

        // Save language state
        vscode.setState({ language: currentLanguage });
      });

      // Auto-resize result area
      function adjustResultHeight() {
        const resultSection = document.querySelector(".result-section");
        const fixedControls = document.querySelector(".fixed-controls");
        const header = document.querySelector(".header");
        const footer = document.querySelector(".footer");

        const availableHeight =
          window.innerHeight - header.offsetHeight - footer.offsetHeight;
        const fixedControlsHeight = fixedControls.offsetHeight;

        resultSection.style.maxHeight = `${
          availableHeight - fixedControlsHeight - 32
        }px`;
      }

      window.addEventListener("resize", adjustResultHeight);
      setTimeout(adjustResultHeight, 100);
    </script>
  </body>
</html>
